stages:
  - build

variables:
  DOCKER_IMAGE: registry.gitlab.com/getnobullshit/france-nuage/website/api:$CI_COMMIT_SHORT_SHA
  # Define required environment variables
  NODE_ENV: $NODE_ENV
  PORT: $PORT
  APP_KEY: $APP_KEY
  HOST: $HOST
  LOG_LEVEL: $LOG_LEVEL
  DB_HOST: $DB_HOST
  DB_PORT: $DB_PORT
  DB_USER: $DB_USER
  DB_PASSWORD: $DB_PASSWORD
  DB_DATABASE: $DB_DATABASE
  LIMITER_STORE: $LIMITER_STORE
  BREVO_API_KEY: $BREVO_API_KEY
  DRIVE_DISK: $DRIVE_DISK
  R2_KEY: $R2_KEY
  R2_SECRET: $R2_SECRET
  R2_BUCKET: $R2_BUCKET
  R2_ENDPOINT: $R2_ENDPOINT
  STRIPE_SECRET_KEY: $STRIPE_SECRET_KEY

build:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  variables:
    DOCKER_DRIVER: overlay2
  before_script:
    # Log in to the GitLab Container Registry
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" "$CI_REGISTRY" --password-stdin
  script:
    # Build the Docker image from the root, specify the Dockerfile in apps/api
    - docker build -f apps/api/Dockerfile --build-arg NODE_ENV=$NODE_ENV \
                                       --build-arg PORT=$PORT \
                                       --build-arg APP_KEY=$APP_KEY \
                                       --build-arg HOST=$HOST \
                                       --build-arg LOG_LEVEL=$LOG_LEVEL \
                                       --build-arg DB_HOST=$DB_HOST \
                                       --build-arg DB_PORT=$DB_PORT \
                                       --build-arg DB_USER=$DB_USER \
                                       --build-arg DB_PASSWORD=$DB_PASSWORD \
                                       --build-arg DB_DATABASE=$DB_DATABASE \
                                       --build-arg LIMITER_STORE=$LIMITER_STORE \
                                       --build-arg BREVO_API_KEY=$BREVO_API_KEY \
                                       --build-arg DRIVE_DISK=$DRIVE_DISK \
                                       --build-arg R2_KEY=$R2_KEY \
                                       --build-arg R2_SECRET=$R2_SECRET \
                                       --build-arg R2_BUCKET=$R2_BUCKET \
                                       --build-arg R2_ENDPOINT=$R2_ENDPOINT \
                                       --build-arg STRIPE_SECRET_KEY=$STRIPE_SECRET_KEY \
                                       -t $DOCKER_IMAGE .
    # Push the Docker image to the GitLab Container Registry
    - docker push $DOCKER_IMAGE
  only:
    - master
    - staging  # Run on master and staging branches
