# Prevent duplicate pipelines for merge requests
workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS
      when: never
    - if: $CI_COMMIT_BRANCH

# Define the pipeline stages
stages:
  - security
  - build
  - code-style
  - unit-tests
  - helm-deploy
  - deploy
  - system-tests
  - documentation
  - release

default:
  image: registry.france-nuage.fr/library/docker:29
  services: []

variables:
  GIT_DEPTH: 1
  GIT_STRATEGY: fetch

# template buildkit
.buildkit_template:
  image: registry.france-nuage.fr/library/docker:29
  services: []
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
    - |
      cat > /tmp/buildkitd.toml <<'EOF'
      [registry."docker.io"]
        mirrors = ["registry.france-nuage.fr"]
      EOF
    - |
      docker buildx create \
        --driver=kubernetes \
        --driver-opt=namespace=${BUILDKIT_NAMESPACE:-${KUBE_CI_NAMESPACE_NAME}} \
        --driver-opt=rootless=true \
        --driver-opt=image=registry.france-nuage.fr/moby/buildkit:rootless \
        --driver-opt=replicas=1 \
        --driver-opt=requests.cpu=100m \
        --driver-opt=requests.memory=2Gi \
        --driver-opt=limits.cpu=2 \
        --driver-opt=limits.memory=8Gi \
        --buildkitd-config=/tmp/buildkitd.toml \
        --name=k8s-builder-${CI_JOB_ID} \
        --use
    - docker buildx inspect --bootstrap
    - sleep 5
  after_script:
    - docker buildx rm k8s-builder-${CI_JOB_ID} || true

gitleaks:
  stage: security
  image:
    name: registry.france-nuage.fr/zricethezav/gitleaks:v8.24.2
    entrypoint: [""]
  services: []
  before_script: []
  script:
    - >
      gitleaks detect
      --source .
      --verbose
      --report-format json
      --report-path gitleaks-report.json
      --exit-code 1
  artifacts:
    paths:
      - gitleaks-report.json
    when: always
    expire_in: 1 week

.build_template: &build_template
  stage: build
  variables:
    TARGET: development

# Unified build job for all Rust services (controlplane, operation-worker, synchronizer)
# Builds all 3 binaries in a single cargo invocation to share compilation
"build / rust-services":
  extends: .buildkit_template
  stage: build
  script:
    - |
      set -e

      # Build all 3 services using the unified Dockerfile
      # First build compiles the entire workspace and exports cache
      # Subsequent builds reuse that cache (near-instant)

      # Build 1: controlplane (exports full workspace cache)
      docker buildx build \
        --cache-from type=registry,ref=${CI_REGISTRY_IMAGE}/rust-services:buildcache \
        --cache-from type=registry,ref=${CI_REGISTRY_IMAGE}/rust-services:buildcache-${CI_COMMIT_REF_SLUG} \
        --cache-from type=registry,ref=${CI_REGISTRY_IMAGE}/controlplane:${CI_COMMIT_REF_SLUG}-development \
        --cache-from type=registry,ref=${CI_REGISTRY_IMAGE}/controlplane:master-development \
        --cache-to type=registry,ref=${CI_REGISTRY_IMAGE}/rust-services:buildcache-${CI_COMMIT_REF_SLUG},mode=max \
        --cache-to type=registry,ref=${CI_REGISTRY_IMAGE}/rust-services:buildcache,mode=max \
        --target development \
        --tag ${CI_REGISTRY_IMAGE}/controlplane:${CI_COMMIT_REF_SLUG}-development \
        --push \
        --file controlplane/Dockerfile \
        controlplane

      # Build 2: operation-worker (reuses cache from build 1, no export)
      docker buildx build \
        --cache-from type=registry,ref=${CI_REGISTRY_IMAGE}/rust-services:buildcache \
        --cache-from type=registry,ref=${CI_REGISTRY_IMAGE}/rust-services:buildcache-${CI_COMMIT_REF_SLUG} \
        --cache-from type=registry,ref=${CI_REGISTRY_IMAGE}/operation-worker:${CI_COMMIT_REF_SLUG}-development \
        --cache-from type=registry,ref=${CI_REGISTRY_IMAGE}/operation-worker:master-development \
        --target development-operation-worker \
        --tag ${CI_REGISTRY_IMAGE}/operation-worker:${CI_COMMIT_REF_SLUG}-development \
        --push \
        --file controlplane/Dockerfile \
        controlplane

      # Build 3: synchronizer (reuses cache from build 1, no export)
      docker buildx build \
        --cache-from type=registry,ref=${CI_REGISTRY_IMAGE}/rust-services:buildcache \
        --cache-from type=registry,ref=${CI_REGISTRY_IMAGE}/rust-services:buildcache-${CI_COMMIT_REF_SLUG} \
        --cache-from type=registry,ref=${CI_REGISTRY_IMAGE}/synchronizer:${CI_COMMIT_REF_SLUG}-development \
        --cache-from type=registry,ref=${CI_REGISTRY_IMAGE}/synchronizer:master-development \
        --target development-synchronizer \
        --tag ${CI_REGISTRY_IMAGE}/synchronizer:${CI_COMMIT_REF_SLUG}-development \
        --push \
        --file controlplane/Dockerfile \
        controlplane
  rules:
    - changes:
        - controlplane/**/*
        - .gitlab-ci.yml

"build / console":
  extends: .buildkit_template
  stage: build
  variables:
    TARGET: development
  script:
    - |
      set -e
      docker buildx build \
        --cache-from type=registry,ref=${CI_REGISTRY_IMAGE}/console:buildcache \
        --cache-from type=registry,ref=${CI_REGISTRY_IMAGE}/console:buildcache-${CI_COMMIT_REF_SLUG} \
        --cache-from type=registry,ref=${CI_REGISTRY_IMAGE}/console:${CI_COMMIT_REF_SLUG}-${TARGET} \
        --cache-from type=registry,ref=${CI_REGISTRY_IMAGE}/console:master-${TARGET} \
        --cache-to type=registry,ref=${CI_REGISTRY_IMAGE}/console:buildcache-${CI_COMMIT_REF_SLUG},mode=max \
        --cache-to type=registry,ref=${CI_REGISTRY_IMAGE}/console:buildcache,mode=max \
        --build-arg VITE_OIDC_CLIENT_ID=${OIDC_CLIENT_ID:-francenuage} \
        --build-arg VITE_OIDC_PROVIDER_NAME=${OIDC_PROVIDER_NAME:-keycloak} \
        --build-arg VITE_OIDC_PROVIDER_URL=${OIDC_PROVIDER_URL:-https://keycloak.test/realms/francenuage} \
        --build-arg VITE_APPLICATION_DEFAULT_MODE=${VITE_APPLICATION_DEFAULT_MODE:-rpc} \
        --build-arg VITE_CONTROLPLANE_URL=${CONTROLPLANE_URL:-https://controlplane.test} \
        --target ${TARGET} \
        --tag ${CI_REGISTRY_IMAGE}/console:${CI_COMMIT_REF_SLUG}-${TARGET} \
        --push \
        --file console/Dockerfile \
        .
  rules:
    - changes:
        - console/**/*
        - node-sdk/**/*
        - .gitlab-ci.yml

"build / node-sdk":
  extends: .buildkit_template
  stage: build
  script:
    - |
      set -e
      docker buildx build \
        --cache-from type=registry,ref=${CI_REGISTRY_IMAGE}/node-sdk:buildcache \
        --cache-from type=registry,ref=${CI_REGISTRY_IMAGE}/node-sdk:buildcache-${CI_COMMIT_REF_SLUG} \
        --cache-from type=registry,ref=${CI_REGISTRY_IMAGE}/node-sdk:${CI_COMMIT_REF_SLUG} \
        --cache-from type=registry,ref=${CI_REGISTRY_IMAGE}/node-sdk:master \
        --cache-to type=registry,ref=${CI_REGISTRY_IMAGE}/node-sdk:buildcache-${CI_COMMIT_REF_SLUG},mode=max \
        --cache-to type=registry,ref=${CI_REGISTRY_IMAGE}/node-sdk:buildcache,mode=max \
        --tag ${CI_REGISTRY_IMAGE}/node-sdk:${CI_COMMIT_REF_SLUG} \
        --push \
        --file node-sdk/Dockerfile \
        node-sdk
  rules:
    - changes:
        - controlplane/**/*
        - node-sdk/**/*
        - .gitlab-ci.yml

"build / system-tests":
  extends: .buildkit_template
  stage: build
  script:
    - |
      set -e
      docker buildx build \
        --cache-from type=registry,ref=${CI_REGISTRY_IMAGE}/system-tests:buildcache \
        --cache-from type=registry,ref=${CI_REGISTRY_IMAGE}/system-tests:buildcache-${CI_COMMIT_REF_SLUG} \
        --cache-from type=registry,ref=${CI_REGISTRY_IMAGE}/system-tests:${CI_COMMIT_REF_SLUG} \
        --cache-from type=registry,ref=${CI_REGISTRY_IMAGE}/system-tests:master \
        --cache-to type=registry,ref=${CI_REGISTRY_IMAGE}/system-tests:buildcache-${CI_COMMIT_REF_SLUG},mode=max \
        --cache-to type=registry,ref=${CI_REGISTRY_IMAGE}/system-tests:buildcache,mode=max \
        --tag ${CI_REGISTRY_IMAGE}/system-tests:${CI_COMMIT_REF_SLUG} \
        --push \
        --file system-tests/Dockerfile \
        .
  rules:
    - changes:
        - controlplane/**/*
        - node-sdk/**/*
        - system-tests/**/*
        - .gitlab-ci.yml

"build / protocol":
  extends: .buildkit_template
  stage: build
  script:
    - |
      set -e
      docker buildx build \
        --cache-from type=registry,ref=${CI_REGISTRY_IMAGE}/protocol:buildcache \
        --cache-from type=registry,ref=${CI_REGISTRY_IMAGE}/protocol:buildcache-${CI_COMMIT_REF_SLUG} \
        --cache-from type=registry,ref=${CI_REGISTRY_IMAGE}/protocol:${CI_COMMIT_REF_SLUG} \
        --cache-from type=registry,ref=${CI_REGISTRY_IMAGE}/protocol:master \
        --cache-to type=registry,ref=${CI_REGISTRY_IMAGE}/protocol:buildcache-${CI_COMMIT_REF_SLUG},mode=max \
        --cache-to type=registry,ref=${CI_REGISTRY_IMAGE}/protocol:buildcache,mode=max \
        --tag ${CI_REGISTRY_IMAGE}/protocol:${CI_COMMIT_REF_SLUG} \
        --push \
        --file protocol/Dockerfile \
        protocol
  rules:
    - changes:
        - protocol/**/*
        - .gitlab-ci.yml

# Unified release build for all Rust services
# Compiles workspace once, produces 3 release images
"build / rust-services / release":
  extends: .buildkit_template
  stage: build
  variables:
    TARGET: release
  script:
    - |
      set -e

      # Build 1: controlplane release (exports full workspace cache)
      docker buildx build \
        --cache-from type=registry,ref=${CI_REGISTRY_IMAGE}/rust-services:buildcache \
        --cache-from type=registry,ref=${CI_REGISTRY_IMAGE}/rust-services:buildcache-${CI_COMMIT_REF_SLUG} \
        --cache-from type=registry,ref=${CI_REGISTRY_IMAGE}/controlplane:${CI_COMMIT_REF_SLUG}-${TARGET} \
        --cache-from type=registry,ref=${CI_REGISTRY_IMAGE}/controlplane:master-${TARGET} \
        --cache-to type=registry,ref=${CI_REGISTRY_IMAGE}/rust-services:buildcache-${CI_COMMIT_REF_SLUG},mode=max \
        --cache-to type=registry,ref=${CI_REGISTRY_IMAGE}/rust-services:buildcache,mode=max \
        --target ${TARGET} \
        --tag ${CI_REGISTRY_IMAGE}/controlplane:${CI_COMMIT_REF_SLUG}-${TARGET} \
        --push \
        --file controlplane/Dockerfile \
        controlplane

      # Build 2: operation-worker release (reuses cache, no export)
      docker buildx build \
        --cache-from type=registry,ref=${CI_REGISTRY_IMAGE}/rust-services:buildcache \
        --cache-from type=registry,ref=${CI_REGISTRY_IMAGE}/rust-services:buildcache-${CI_COMMIT_REF_SLUG} \
        --cache-from type=registry,ref=${CI_REGISTRY_IMAGE}/operation-worker:${CI_COMMIT_REF_SLUG}-${TARGET} \
        --cache-from type=registry,ref=${CI_REGISTRY_IMAGE}/operation-worker:master-${TARGET} \
        --target ${TARGET}-operation-worker \
        --tag ${CI_REGISTRY_IMAGE}/operation-worker:${CI_COMMIT_REF_SLUG}-${TARGET} \
        --push \
        --file controlplane/Dockerfile \
        controlplane

      # Build 3: synchronizer release (reuses cache, no export)
      docker buildx build \
        --cache-from type=registry,ref=${CI_REGISTRY_IMAGE}/rust-services:buildcache \
        --cache-from type=registry,ref=${CI_REGISTRY_IMAGE}/rust-services:buildcache-${CI_COMMIT_REF_SLUG} \
        --cache-from type=registry,ref=${CI_REGISTRY_IMAGE}/synchronizer:${CI_COMMIT_REF_SLUG}-${TARGET} \
        --cache-from type=registry,ref=${CI_REGISTRY_IMAGE}/synchronizer:master-${TARGET} \
        --target ${TARGET}-synchronizer \
        --tag ${CI_REGISTRY_IMAGE}/synchronizer:${CI_COMMIT_REF_SLUG}-${TARGET} \
        --push \
        --file controlplane/Dockerfile \
        controlplane
  rules:
    - changes:
        - controlplane/**/*
        - .gitlab-ci.yml

"build / console / release":
  extends: .buildkit_template
  stage: build
  variables:
    TARGET: release
  script:
    - |
      set -e
      docker buildx build \
        --cache-from type=registry,ref=${CI_REGISTRY_IMAGE}/console:buildcache \
        --cache-from type=registry,ref=${CI_REGISTRY_IMAGE}/console:buildcache-${CI_COMMIT_REF_SLUG} \
        --cache-from type=registry,ref=${CI_REGISTRY_IMAGE}/console:${CI_COMMIT_REF_SLUG}-${TARGET} \
        --cache-from type=registry,ref=${CI_REGISTRY_IMAGE}/console:master-${TARGET} \
        --cache-to type=registry,ref=${CI_REGISTRY_IMAGE}/console:buildcache-${CI_COMMIT_REF_SLUG},mode=max \
        --cache-to type=registry,ref=${CI_REGISTRY_IMAGE}/console:buildcache,mode=max \
        --build-arg VITE_OIDC_CLIENT_ID=${OIDC_CLIENT_ID:-francenuage} \
        --build-arg VITE_OIDC_PROVIDER_NAME=${OIDC_PROVIDER_NAME:-keycloak} \
        --build-arg VITE_OIDC_PROVIDER_URL=${OIDC_PROVIDER_URL:-https://keycloak.test/realms/francenuage} \
        --build-arg VITE_APPLICATION_DEFAULT_MODE=${VITE_APPLICATION_DEFAULT_MODE:-rpc} \
        --build-arg VITE_CONTROLPLANE_URL=${CONTROLPLANE_URL:-https://controlplane.test} \
        --target ${TARGET} \
        --tag ${CI_REGISTRY_IMAGE}/console:${CI_COMMIT_REF_SLUG}-${TARGET} \
        --push \
        --file console/Dockerfile \
        .
  rules:
    - changes:
        - console/**/*
        - controlplane/**/*
        - node-sdk/**/*
        - .gitlab-ci.yml

"build / system-tests / release":
  extends: .buildkit_template
  stage: build
  script:
    - |
      set -e
      docker buildx build \
        --cache-from type=registry,ref=${CI_REGISTRY_IMAGE}/system-tests:buildcache \
        --cache-from type=registry,ref=${CI_REGISTRY_IMAGE}/system-tests:buildcache-${CI_COMMIT_REF_SLUG} \
        --cache-from type=registry,ref=${CI_REGISTRY_IMAGE}/system-tests:${CI_COMMIT_REF_SLUG}-release \
        --cache-from type=registry,ref=${CI_REGISTRY_IMAGE}/system-tests:master-release \
        --cache-to type=registry,ref=${CI_REGISTRY_IMAGE}/system-tests:buildcache-${CI_COMMIT_REF_SLUG},mode=max \
        --cache-to type=registry,ref=${CI_REGISTRY_IMAGE}/system-tests:buildcache,mode=max \
        --tag ${CI_REGISTRY_IMAGE}/system-tests:${CI_COMMIT_REF_SLUG}-release \
        --push \
        --file system-tests/Dockerfile \
        .
  rules:
    - changes:
        - console/**/*
        - controlplane/**/*
        - system-tests/**/*
        - node-sdk/**/*
        - helm/**/*
        - .gitlab-ci.yml

"build / protocol / release":
  extends: .buildkit_template
  stage: build
  script:
    - |
      set -e
      docker buildx build \
        --cache-from type=registry,ref=${CI_REGISTRY_IMAGE}/protocol:buildcache \
        --cache-from type=registry,ref=${CI_REGISTRY_IMAGE}/protocol:buildcache-${CI_COMMIT_REF_SLUG} \
        --cache-from type=registry,ref=${CI_REGISTRY_IMAGE}/protocol:${CI_COMMIT_REF_SLUG} \
        --cache-from type=registry,ref=${CI_REGISTRY_IMAGE}/protocol:master \
        --cache-to type=registry,ref=${CI_REGISTRY_IMAGE}/protocol:buildcache-${CI_COMMIT_REF_SLUG},mode=max \
        --cache-to type=registry,ref=${CI_REGISTRY_IMAGE}/protocol:buildcache,mode=max \
        --tag ${CI_REGISTRY_IMAGE}/protocol:${CI_COMMIT_REF_SLUG} \
        --push \
        --file protocol/Dockerfile \
        protocol
  rules:
    - changes:
        - protocol/**/*
        - .gitlab-ci.yml

"code style / controlplane":
  stage: code-style
  image: registry.france-nuage.fr/library/rust:1.90-alpine
  services: []
  needs: []
  variables:
    SQLX_OFFLINE: "true"
  before_script:
    - apk add --no-cache musl-dev openssl-dev openssl-libs-static protobuf-dev
    - rustup component add rustfmt clippy
    - cd controlplane
  script:
    - cargo fmt --check
    - cargo clippy --workspace -- -D warnings
  rules:
    - changes:
        - controlplane/**/*
        - .gitlab-ci.yml

"code style / console":
  stage: code-style
  image: registry.france-nuage.fr/library/node:22-alpine
  services: []
  needs: []
  before_script:
    - cd console
    - npm ci
  script:
    - npm run lint
    - npx prettier --check .
  rules:
    - changes:
        - console/**/*
        - .gitlab-ci.yml

"code style / node-sdk":
  stage: code-style
  image: registry.france-nuage.fr/library/node:22-alpine
  services: []
  needs: []
  before_script:
    - cd node-sdk
    - npm ci
  script:
    - npm run lint
    - npx prettier --check .
  rules:
    - changes:
        - node-sdk/**/*
        - .gitlab-ci.yml

"code style / markdown":
  stage: code-style
  image: registry.france-nuage.fr/library/node:22-alpine
  services: []
  needs: []
  script:
    - npm install -g markdownlint-cli2 #pour qu'il prenne en compte le .markdownlint-cli2.yml
    - markdownlint-cli2
  rules:
    - changes:
        - "**/*.md"
        - .gitlab-ci.yml

"unit tests / authz":
  stage: unit-tests
  image: registry.france-nuage.fr/library/alpine:latest
  services: []
  needs: []
  before_script:
    - apk add --no-cache wget
    - wget https://github.com/authzed/zed/releases/download/v0.34.1/zed_0.34.1_linux_amd64.apk
    - apk add --allow-untrusted zed_0.34.1_linux_amd64.apk
  script:
    - cd authz
    - zed validate tests.yaml
  rules:
    - changes:
        - authz/**/*
        - .gitlab-ci.yml

"unit tests / migration linting":
  stage: unit-tests
  image:
    name: registry.france-nuage.fr/arigaio/atlas@sha256:591872655a7758a60edcb6a23e60caee2fd3ae3fb08bceb8bc4e095f6d5013b5
    entrypoint: [""]
  needs: []
  services:
    - name: registry.france-nuage.fr/library/postgres:16-alpine
      alias: atlas-dev-database
  variables:
    GIT_DEPTH: 0
    GIT_STRATEGY: clone
    POSTGRES_PASSWORD: postgres
    POSTGRES_USER: postgres
    POSTGRES_DB: test
  before_script:
    - apk add --no-cache git
  script:
    - |
      atlas migrate lint \
        --dev-url="postgres://postgres:postgres@atlas-dev-database:5432/test?sslmode=disable" \
        --dir="file://controlplane/migrations" \
        --git-base=origin/master
  rules:
    - changes:
        - controlplane/migrations/**/*
        - .gitlab-ci.yml

"unit tests / controlplane":
  stage: unit-tests
  image: registry.france-nuage.fr/library/rust:1.90-alpine
  needs: []
  services:
    - name: registry.france-nuage.fr/library/postgres:16-alpine
      alias: test-postgres
  variables:
    CARGO_INCREMENTAL: "0"
    SQLX_OFFLINE: "true"
    POSTGRES_PASSWORD: postgres
    POSTGRES_USER: postgres
    POSTGRES_DB: test
    DATABASE_URL: "postgres://postgres:postgres@test-postgres:5432/test"
  before_script:
    - apk add --no-cache musl-dev openssl-dev openssl-libs-static protobuf-dev
    - cd controlplane
  script:
    - cargo test --workspace --all-features
  rules:
    - changes:
        - controlplane/**/*
        - .gitlab-ci.yml

.helm_template:
  image: alpine/helm:latest
  services: []
  before_script:
    - apk add --no-cache kubectl
    - echo "$KUBECONFIG_CONTENT" | base64 -d > /tmp/kubeconfig
    - export KUBECONFIG=/tmp/kubeconfig
    - kubectl version --client
    - helm version

"deploy / ci-environment":
  extends: .helm_template
  stage: deploy
  resource_group: "deploy-ci-${CI_COMMIT_REF_SLUG}"
  environment:
    name: ci
    on_stop: "cleanup / ci-environment"
  variables:
    NAMESPACE: "${KUBE_CI_NAMESPACE_NAME}"
    RELEASE_NAME: "plateforme-ci-${CI_COMMIT_SHORT_SHA}"
    GIT_DEPTH: 0
    GIT_STRATEGY: clone
  script:
    - |
      set -e
      # Tente de rollback le release précédent si existant (ignore les erreurs)
      helm rollback ${RELEASE_NAME} -n ${NAMESPACE} 2>/dev/null || true

      # Déploie ou met à jour la release Helm pour l'environnement CI
      helm upgrade --install ${RELEASE_NAME} ./helm/plateforme \
        --namespace ${NAMESPACE} \
        --values ./helm/plateforme/values-ci.yaml \
        --set global.imageRegistry=${CI_REGISTRY_IMAGE} \
        --set global.imageTag=${CI_COMMIT_REF_SLUG}-release \
        --set global.imagePullPolicy=Always \
        --set secrets.postgresPassword="postgres" \
        --set secrets.spicedbPassword="spicedb_password" \
        --set secrets.spicedbPresharedKey="${SPICEDB_TOKEN}" \
        --set secrets.keycloakAdminPassword="admin" \
        --set controlplane.config.rootServiceAccountKey="ci-root-sa-key" \
        --set controlplane.config.oidcUrl=http://${RELEASE_NAME}-keycloak:8080/realms/francenuage/.well-known/openid-configuration \
        --set console.config.apiUrl=http://${RELEASE_NAME}-controlplane \
        --set systemTests.config.consoleUrl=http://${RELEASE_NAME}-console \
        --set systemTests.config.controlplaneUrl=http://${RELEASE_NAME}-controlplane \
        --set systemTests.config.keycloakUrl=http://${RELEASE_NAME}-keycloak:8080 \
        --set systemTests.config.oidcProviderUrl=http://${RELEASE_NAME}-keycloak:8080/realms/francenuage/.well-known/openid-configuration \
        --wait \
        --timeout 10m

      kubectl wait --for=condition=available --timeout=5m \
        deployment -l app.kubernetes.io/instance=${RELEASE_NAME} -n ${NAMESPACE}
  rules:
    - changes:
        - controlplane/**/*
        - console/**/*
        - node-sdk/**/*
        - system-tests/**/*
        - helm/**/*
        - .gitlab-ci.yml

"cleanup / ci-environment":
  extends: .helm_template
  stage: deploy
  environment:
    name: ci
    action: stop
  variables:
    NAMESPACE: "${KUBE_CI_NAMESPACE_NAME}"
    RELEASE_NAME: "plateforme-ci-${CI_COMMIT_SHORT_SHA}"
  script:
    - helm uninstall ${RELEASE_NAME} --namespace ${NAMESPACE} || true
    - kubectl delete pvc -l app.kubernetes.io/instance=${RELEASE_NAME} -n ${NAMESPACE} || true
  when: manual
  rules:

"system tests / kubernetes":
  extends: .helm_template
  stage: system-tests
  needs:
    - job: "deploy / production"
      artifacts: false
  allow_failure: true
  variables:
    NAMESPACE: "${KUBE_CI_NAMESPACE_NAME}"
    RELEASE_NAME: "plateforme-ci-${CI_COMMIT_SHORT_SHA}"
  script:
    - |
      set -e
      kubectl wait --for=condition=complete --timeout=15m \
        job/${RELEASE_NAME}-plateforme-system-tests -n ${NAMESPACE} || true

      kubectl logs -n ${NAMESPACE} job/${RELEASE_NAME}-plateforme-system-tests > system-tests-logs.txt || true

      if kubectl get job ${RELEASE_NAME}-plateforme-system-tests -n ${NAMESPACE} -o jsonpath='{.status.succeeded}' | grep -q "1"; then
        echo "System tests passed!"
        exit 0
      else
        echo "System tests failed!"
        exit 1
      fi
  artifacts:
    when: always
    paths:
      - system-tests-logs.txt
    expire_in: 1 week
  rules:
    - changes:
        - controlplane/**/*
        - console/**/*
        - node-sdk/**/*
        - system-tests/**/*
        - helm/**/*
        - .gitlab-ci.yml

"deploy / production":
  extends: .helm_template
  stage: deploy
  resource_group: "deploy-production"
  environment:
    name: production
    on_stop: "cleanup / production"
  variables:
    NAMESPACE: "${KUBE_CI_NAMESPACE_NAME}"
    RELEASE_NAME: "plateforme-prod"
    GIT_DEPTH: 0
    GIT_STRATEGY: clone
  script:
    - |
      set -e
      helm rollback ${RELEASE_NAME} -n ${NAMESPACE} 2>/dev/null || true
      
      helm upgrade --install ${RELEASE_NAME} ./helm/plateforme \
        --namespace ${NAMESPACE} \
        --values ./helm/plateforme/values-prod.yaml \
        --set global.imageRegistry=${CI_REGISTRY_IMAGE} \
        --set global.imageTag=${CI_COMMIT_REF_SLUG}-release \
        --set global.imagePullPolicy=Always \
        --set controlplane.config.oidcUrl=http://${RELEASE_NAME}-keycloak:8080/realms/francenuage/.well-known/openid-configuration \
        --set console.config.apiUrl=http://${RELEASE_NAME}-controlplane \
        --set systemTests.config.consoleUrl=http://${RELEASE_NAME}-console \
        --set systemTests.config.controlplaneUrl=http://${RELEASE_NAME}-controlplane \
        --set systemTests.config.keycloakUrl=http://${RELEASE_NAME}-keycloak:8080 \
        --set systemTests.config.oidcProviderUrl=http://${RELEASE_NAME}-keycloak:8080/realms/francenuage/.well-known/openid-configuration \
        --wait \
        --timeout 10m

      kubectl wait --for=condition=available --timeout=5m \
        deployment -l app.kubernetes.io/instance=${RELEASE_NAME} -n ${NAMESPACE}
  rules:
    - when: manual

"cleanup / production":
  extends: .helm_template
  stage: deploy
  environment:
    name: production
    action: stop
  variables:
    NAMESPACE: "${KUBE_CI_NAMESPACE_NAME}"
    RELEASE_NAME: "plateforme-prod"
  script:
    - helm uninstall ${RELEASE_NAME} --namespace ${NAMESPACE} || true
    - kubectl delete pvc -l app.kubernetes.io/instance=${RELEASE_NAME} -n ${NAMESPACE} || true
  when: manual
  rules:
    - when: manual

"release":
  image: registry.france-nuage.fr/library/node:22-alpine
  services: []
  stage: release
  variables:
    CI: true
    HUSKY: 0
    GIT_DEPTH: 0
    GIT_STRATEGY: clone
  before_script:
    - apk add --no-cache git
    - git remote set-url origin "https://oauth2:${GITLAB_TOKEN}@gitlab.com/${CI_PROJECT_PATH}.git"
    - npm ci
  script:
    - npx semantic-release
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
      when: on_success
    - when: never
