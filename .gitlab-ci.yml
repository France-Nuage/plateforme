cache:
  paths:
    - apps/api/node_modules/
    - apps/platform/node_modules/
    - node_modules/

stages:
  - tmp
  - install
  - code-style
  - build
  - test
  - migrate
  - deployment
  - post-deployment
  - cleanup

include:
  - local: "apps/api/.gitlab-ci.yml"
  - local: "apps/platform/.gitlab-ci.yml"
  - local: "apps/worker-vm-status/.gitlab-ci.yml"

# before_script:

install:
  image: node:22
  stage: install
  script:
    - npm install
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - .npm-cache
      - .turbo
  artifacts:
    paths:
      - node_modules/
      - .npm-cache
      - .turbo

eslint:
  image: node:22
  stage: code-style
  dependencies:
    - install
  script:
    - npm run lint

prettier:
  image: node:22
  stage: code-style
  dependencies:
    - install
  script:
    - npm run format:check

integration-tests:
  image: docker:27-dind
  stage: tmp
  script:
    - docker compose up -d
    - docker compose ps
    - sleep 15
    - docker compose exec platform npx playwright test
  after_script:
    - docker compose ps
    - docker compose logs platform

docker-storage-cleanup:
  stage: cleanup
  image: docker:latest
  variables:
    DOCKER_HOST: unix:///var/run/docker.sock
  script:
    - docker system prune -af
    - docker image prune -af
    - docker volume prune -af
