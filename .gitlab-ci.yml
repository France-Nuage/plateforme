# Define the pipeline stages
stages:
  - documentation
  - security
  - sync
  - build
  - code-style
  - unit-tests
  - system-tests
  - commit
  - release
  - deploy

# Define the default image
image: docker:27-cli

# Define the docker-dind service that is started for each job
services:
  - name: docker:27-dind

# Define the preliminary scripts to run before every job
before_script:
  - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY

gitleaks:
  stage: security
  script:
    - docker run --rm -v $(pwd):/src zricethezav/gitleaks:v8.24.2 detect --source /src --verbose --report-format json --report-path /src/gitleaks-report.json --exit-code 1
  artifacts:
    paths:
      - gitleaks-report.json
    when: always
    expire_in: 1 week

"sync console with plasmic":
  stage: sync
  image: node:22-alpine
  before_script:
    - cd console
    - npm install -g global @plasmicapp/cli
    - npm install --save-dev prettier
  script:
    - plasmic sync --projects ${PLASMIC_CONSOLE_PROJECT_ID} --yes --force
    - npx prettier --write .
  artifacts:
    paths:
      - ./console/components/
      - ./console/pages/
      - ./console/styles/
      - ./console/public/
    expire_in: 1 hour

build:
  stage: build
  script:
    - docker compose build --build-arg BUILDKIT_INLINE_CACHE=1
    - docker compose push
  dependencies:
    - "sync console with plasmic"

"code style / controlplane":
  stage: code-style
  variables:
    SQLX_OFFLINE: true
  script:
    - docker compose run --no-deps controlplane cargo fmt --check
    - docker compose run --no-deps controlplane cargo clippy

"code style / console":
  stage: code-style
  script:
    - docker compose run --no-deps console npm run lint
    - docker compose run --no-deps console npx prettier --check .
  dependencies:
    - "sync console with plasmic"

"unit tests / controlplane":
  stage: unit-tests
  variables:
    CARGO_INCREMENTAL: "0"
    LLVM_PROFILE_FILE: "cargo-test-%p-%m.profraw"
    RUSTFLAGS: "-Cinstrument-coverage"
    SQLX_OFFLINE: true
  script:
    - docker compose run controlplane cargo test --workspace
    - docker compose run controlplane grcov . --binary-path ./target/debug/deps/ -s . -t cobertura --branch --ignore-not-existing --ignore '../*' --ignore "/*" -o target/cobertura.xml
    - >
      docker compose run --build --no-deps --remove-orphans controlplane sh -c "xmllint --xpath \"concat('Coverage: ', 100 * string(//coverage/@line-rate), '%')\" target/cobertura.xml"
  coverage: '/Coverage: \d+(?:\.\d+)?/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: controlplane/target/cobertura.xml

"system tests / console":
  stage: system-tests
  variables:
    TARGET: release
    NEXT_PUBLIC_CONTROLPLANE_URL: https://controlplane.france-nuage.fr
  script:
    - docker compose run system-tests npm run test:ci
  dependencies:
    - "sync console with plasmic"
  artifacts:
    when: always
    paths:
      - system-tests/playwright-report/
    expire_in: 1 week

"commit new plasmic code":
  stage: commit
  variables:
    GIT_STRATEGY: clone
  before_script:
    - apk add --no-cache git
    - git config --global user.email "gitlab@france-nuage.fr"
    - git config --global user.name "Gitlab Service Account"
  script:
    - git remote set-url origin "https://oauth2:${GITLAB_TOKEN}@gitlab.com/${CI_PROJECT_PATH}.git"
    - git add *
    - >
      git commit -m "feat: add plasmic changes [ci skip]" || echo "No changes to commit"
    - git push origin HEAD:master
  dependencies:
    - "sync console with plasmic"
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
      when: on_success
    - when: never

"deploy / controlplane":
  stage: deploy
  script:
    - docker build --target=release --tag=${CI_REGISTRY_IMAGE}/controlplane:release --push controlplane
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
      when: on_success
    - when: never

"deploy / console":
  stage: deploy
  script:
    - docker build --target=release --tag=${CI_REGISTRY_IMAGE}/console:release --push console
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
      when: on_success
    - when: never
  dependencies:
    - "sync console with plasmic"

"documentation / controlplane":
  stage: documentation
  image: golang:1.19-alpine
  before_script:
    # Installing dependencies
    - apk add --no-cache grpc-plugins protobuf-dev bash
    - apk add --update nodejs npm

    # Installing protoc-gen-doc
    - go install github.com/pseudomuto/protoc-gen-doc/cmd/protoc-gen-doc@latest

    # Checking installation and identifying exact path
    - which protoc-gen-doc || echo "Not found in PATH"
    - find /go -name "protoc-gen-doc" -type f

    # Making the executable explicitly available and executable
    - chmod +x /go/bin/protoc-gen-doc

    # Adding directly to PATH for this session
    - export PATH=$PATH:/go/bin
    - echo "Current PATH = $PATH"

    # Installing Wrangler for Cloudflare deployment
    - npm install -g wrangler
  script:
    # Final check before execution
    - which protoc-gen-doc || echo "Still not found in PATH"

    # Creating directory and generating documentation
    - mkdir -p ./controlplane/docs
    - protoc -I ./controlplane/instances/ -I ./controlplane/hypervisors/ --doc_out=./controlplane/docs --doc_opt=html,index.html ./controlplane/instances/*.proto ./controlplane/hypervisors/*.proto

    # Checking the result
    - ls -la ./controlplane/docs

    # Deployment On cloudflare pages
    - echo "ðŸš€ Deployment on Cloudflare Pages..."

    # Configuring Cloudflare Authentication
    - cd controlplane/docs

    - export CLOUDFLARE_API_TOKEN="$CF_API_TOKEN"
    - export CLOUDFLARE_ACCOUNT_ID="$CF_ACCOUNT_ID"

    - echo "CLOUDFLARE_API_TOKEN=${CF_API_TOKEN}" > .env
    - echo "CLOUDFLARE_ACCOUNT_ID=${CF_ACCOUNT_ID}" >> .env

    - wrangler pages deploy . --project-name "controlplane-documentation-reference" --branch ${CI_COMMIT_REF_NAME} --commit-hash ${CI_COMMIT_SHA} --commit-message="Updated protobuf documentation - ${CI_COMMIT_MESSAGE}"
      
    # Displaying the deployment URL
    - |
      echo "âœ… Documentation successfully deployed on:"
      echo "ðŸ”— https://france-nuage.com/docs/controlplane/references"
      echo "ðŸ’¡ The deployment may take a few minutes to fully propagate across the Cloudflare network."
#  only:
#    - master

"release":
  image: node:22-alpine
  stage: release
  variables:
    CI: true
    HUSKY: 0
  before_script:
    - apk add --no-cache git
    - git remote set-url origin "https://oauth2:${GITLAB_TOKEN}@gitlab.com/${CI_PROJECT_PATH}.git"
    - npm ci
  script:
    - npx semantic-release
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
      when: on_success
    - when: never
