#
#          ______    ___  _____ ______      _____  ____  _        ___
#         |      |  /  _]/ ___/|      |    |     ||    || |      /  _]
#         |      | /  [_(   \_ |      |    |   __| |  | | |     /  [_
#         |_|  |_||    _]\__  ||_|  |_|    |  |_   |  | | |___ |    _]
#           |  |  |   [_ /  \ |  |  |      |   _]  |  | |     ||   [_
#           |  |  |     |\    |  |  |      |  |    |  | |     ||     |
#           |__|  |_____| \___|  |__|      |__|   |____||_____||_____|


# ce fichier est juste pour tester mon script


Vagrant.configure("2") do |config|
  # Utiliser une box Debian 12 comme base
  config.vm.box = "generic/debian12"

  # Configurer une interface réseau NAT pour l'accès Internet
  config.vm.network "public_network", bridge: "en0: Wi-Fi (Wireless)" # Changez "en0: Wi-Fi" par le nom de votre interface réseau si nécessaire

  # Configurer une interface privée pour SSH ou communication interne
  config.vm.network "private_network", ip: "192.168.56.100"

  # Provision pour installer Proxmox, Python, gérer les clés GPG et corriger les problèmes APT
  config.vm.provision "shell", inline: <<-SHELL
    # Mettre à jour le système
    apt-get update -y || true
    apt-get upgrade -y || true

    # Supprimer les listes de paquets corrompues si nécessaire
    rm -rf /var/lib/apt/lists/*
    apt-get clean
    apt-get update -y

    # Supprimer les paquets problématiques (ex: hunspell-sw)
    dpkg --remove --force-remove-reinstreq hunspell-sw || true
    apt-get install -f -y

    # Installer les pré-requis pour Proxmox
    apt-get install -y wget curl gnupg lsb-release python3 python3-pip

    # Ajouter les clés et le dépôt Proxmox
    wget -qO - http://download.proxmox.com/debian/proxmox-ve-release-6.x.gpg | gpg --dearmor -o /usr/share/keyrings/proxmox.gpg
    echo "deb [signed-by=/usr/share/keyrings/proxmox.gpg] http://download.proxmox.com/debian/pve bullseye pve-no-subscription" > /etc/apt/sources.list.d/pve-no-subscription.list

    # Mettre à jour les paquets et installer Proxmox
    apt-get update -y
    apt-get install -y proxmox-ve || true

    # Installer l'agent QEMU (utile pour l'intégration Proxmox)
    apt-get install -y qemu-guest-agent
    systemctl enable qemu-guest-agent
    systemctl start qemu-guest-agent

    # Vérifier les installations
    python3 --version
    pip3 --version
  SHELL

  # Configurer les ressources de la VM
  config.vm.provider "virtualbox" do |vb|
    vb.memory = "2048" # 2 Go de RAM pour Proxmox
    vb.cpus = 2         # 2 CPU
  end

  # Partage du dossier "Worker" vers le répertoire approprié dans la VM
  config.vm.synced_folder "./Worker", "/vagrant/Worker", type: "virtualbox"
end
