syntax = "proto3";

package francenuage.fr.v1.compute;

import "validate.proto";
import "google/protobuf/timestamp.proto";

// Hypervisors service provides operations to manage hypervisors.
service Hypervisors {
    // List retrieves information about all registered hypervisors.
    rpc List (ListHypervisorsRequest) returns (ListHypervisorsResponse);

    // Register adds a new hypervisor to the system.
    rpc Register (RegisterHypervisorRequest) returns (RegisterHypervisorResponse);

    // Detach removes a hypervisor from the system.
    rpc Detach (DetachHypervisorRequest) returns (DetachHypervisorResponse);
}

// Instances service provides operations to manage instances.
service Instances {
    // ListInstances retrieves information about all available instances.
    rpc List (ListInstancesRequest) returns (ListInstancesResponse);

    // CloneInstance provisions a new instance based on a given existing instance.
    rpc Clone (CloneInstanceRequest) returns (Instance);
  
    // CreateInstance provisions a new instance based on the specified configuration.
    rpc Create (CreateInstanceRequest) returns (CreateInstanceResponse);

    // DeleteInstance deletes a given instance.
    rpc Delete (DeleteInstanceRequest) returns (DeleteInstanceResponse);

    // StartInstance initiates a specific instance identified by its unique ID.
    rpc Start (StartInstanceRequest) returns (StartInstanceResponse);

    // StopInstance halts a specific instance identified by its unique ID.
    rpc Stop (StopInstanceRequest) returns (StopInstanceResponse);

    // Update modifies an existing instance's properties.
    rpc Update (UpdateInstanceRequest) returns (UpdateInstanceResponse);
}

// Hypervisors service provides operations to manage zones.
service Zones {
    // List retrieves information about all registered zones.
    rpc List (ListZonesRequest) returns (ListZonesResponse);

    // Create adds a new zone.
    rpc Create(CreateZoneRequest) returns (CreateZoneResponse);
}

// Networks service provides operations to manage VPC networks.
// Networks connect resources to each other and enable isolation between clients.
service Networks {
    // Insert creates a new network in the specified project.
    rpc Insert(InsertNetworkRequest) returns (Network);

    // Get retrieves a network by its identifier.
    rpc Get(GetNetworkRequest) returns (Network);

    // List retrieves all networks accessible to the caller.
    rpc List(ListNetworksRequest) returns (NetworkList);

    // Delete removes a network. Fails if instances are still attached.
    rpc Delete(DeleteNetworkRequest) returns (DeleteNetworkResponse);
}

// ListHypervisorsRequest is an empty message for listing hypervisors.
message ListHypervisorsRequest {}

// ListHypervisorsResponse contains a collection of hypervisor information.
message ListHypervisorsResponse {
    // List of hypervisor details
    repeated Hypervisor hypervisors = 1;
}

// RegisterHypervisorRequest contains the necessary information to register a hypervisor.
message RegisterHypervisorRequest {
    // Authorization token for secure API access
    string authorization_token = 1;
 
    // Name of the storage to use for instances
    string storage_name = 2;

    // URL endpoint of the hypervisor API
    string url = 3;

    // Id of the zone this hypervisor belongs to
    string zone_id = 4;

    // Id of the organization this hypervisor belongs to
    string organization_id = 5;
}

// RegisterHypervisorResponse contains the result of a register hypervisor operation.
message RegisterHypervisorResponse {
    // The registered hypervisor.
    Hypervisor hypervisor = 1;
}

// DetachHypervisorRequest contains the necessary information to detach a hypervisor.
message DetachHypervisorRequest {
    // Id of the hypervisor
    string id = 1;
}

// DetachHypervisorResponse contains the result of a DetachHypervisor operation.
message DetachHypervisorResponse {}

// Hypervisor represents a virtualization platform that can host instances.
message Hypervisor {
    // Id of the hypervisor
    string id = 1;

    // Name of the storage to use for instances
    string storage_name = 2;

    // URL endpoint of the hypervisor API
    string url = 3;

    // Id of the zone the hypervisor belongs to
    string zone_id = 4;

    // Id of the organization the hypervisor belongs to
    string organization_id = 5;
}

// InstanceConfig contains basic configuration information for a virtual machine instance.
message InstanceConfig {
    // Unique identifier for the instance configuration
    string id = 1 [(validate.rules).string = {
        min_len: 1, 
        max_len: 36, 
        pattern: "^[a-zA-Z0-9_-]+$"  // Alphanumeric with underscores and hyphens
    }];

    // Display name of the instance configuration
    string name = 2 [(validate.rules).string = {
        min_len: 1,
        max_len: 64,
        pattern: "^[a-zA-Z0-9_\\- ]+$"  // Alphanumeric with spaces, underscores and hyphens
    }];
}

// Instance contains detailed information about a virtual machine instance.
message Instance {
    // Unique identifier for the instance
    string id = 1 [(validate.rules).string = {
        min_len: 1, 
        max_len: 36, 
        pattern: "^[a-zA-Z0-9_-]+$"  // Alphanumeric with underscores and hyphens
    }];
    
    // Current operational status of the instance
    InstanceStatus status = 2 [(validate.rules).enum = {
        defined_only: true  // Must be a defined enum value
    }];
    
    // Maximum CPU cores available to the instance (max 99)
    uint32 max_cpu_cores = 3 [(validate.rules).uint32 = {
        gt: 0,  // Must have at least 1 core
        lte: 99  // Maximum 99 cores
    }];
    
    // Current CPU utilization as a percentage (0.0-100.0)
    float cpu_usage_percent = 4 [(validate.rules).float = { 
        gte: 0.0, 
        lte: 100.0 
    }];
    
    // Maximum memory available to the instance (in bytes, max 64GB)
    uint64 max_memory_bytes = 5 [(validate.rules).uint64 = {
        gt: 0,  // Must have some memory
        lte: 68719476736,  // 64GB = 64 * 1024^3 = 68,719,476,736 bytes
    }];
    
    // Current memory utilization (in bytes, cannot exceed max_memory_bytes)
    uint64 memory_usage_bytes = 6 [(validate.rules).uint64 = {
        gte: 0,  // Cannot be negative
        lte: 68719476736  // 64GB = 64 * 1024^3 = 68,719,476,736 bytes
    }];

    // Maximum disk available to the instance (in bytes, max 64GB)
    uint64 max_disk_bytes = 7 [(validate.rules).uint64 = {
        gt: 0,  // Must have some disk space
        lte: 109951162777600  // 100TB = 100 * 1024^4 = 109,951,162,777,600 bytes
    }];

    // Current disk utilization (in bytes, cannot exceed max_disk_bytes)
    uint64 disk_usage_bytes = 8 [(validate.rules).uint64 = {
        gte: 0,  // Cannot be negative
        lte: 109951162777600  // 100TB = 100 * 1024^4 = 109,951,162,777,600 bytes
    }];

    // Human-readable name, defined on the instance
    string name = 9;

    // The IP v4 address of the instance
    string ip_v4 = 10 [(validate.rules).string = {
        pattern: "^((25[0-5]|(2[0-4]|1\\d|[1-9]|)\\d)\\.?\\b){4}$"
    }];

    // Unique identifier for the instance hypervisor
    string hypervisor_id = 100 [(validate.rules).string = {
        min_len: 1, 
        max_len: 36, 
        pattern: "^[a-zA-Z0-9_-]+$"  // Alphanumeric with underscores and hyphens
    }];

    // Unique identifier for the instance project
    string project_id = 101 [(validate.rules).string = {
        min_len: 1, 
        max_len: 36, 
        pattern: "^[a-zA-Z0-9_-]+$"  // Alphanumeric with underscores and hyphens
    }];

    // Array of network configurations for this instance.
    // Each interface connects the instance to a VPC network.
    repeated NetworkInterface network_interfaces = 428771249;

    // Creation time of the instance
    google.protobuf.Timestamp created_at = 997;

    // Time of the instance last change
    google.protobuf.Timestamp updated_at = 998;

}

// InstanceStatus represents the possible states of a virtual machine instance.
enum InstanceStatus {
  // Instance status is undefined
  UNDEFINED_INSTANCE_STATUS = 0;
  
  // Instance is active and operational
  RUNNING = 1;
  
  // Instance is inactive
  STOPPED = 2;
  
  // Instance is in the process of stopping
  STOPPING = 3;
  
  // Instance is in the process of starting/provisioning
  PROVISIONING = 4;
  
  // Instance is in the staging phase before running
  STAGING = 5;
  
  // Instance is suspended (memory state preserved)
  SUSPENDED = 6;
  
  // Instance is in the process of suspending
  SUSPENDING = 7;
  
  // Instance is permanently terminated
  TERMINATED = 8;
  
  // Instance is in the process of being deprovisioned
  DEPROVISIONING = 9;
  
  // Instance is being repaired
  REPAIRING = 10;
}

// ListInstancesRequest is an empty message for listing instances.
message ListInstancesRequest {}

// ListInstancesResponse contains a collection of instance information.
message ListInstancesResponse {
    // List of instance details
    repeated Instance instances = 1;
}

// DeleteInstanceRequest defines the parameters needed to delete an existing instance.
message DeleteInstanceRequest {
    // The id of the instance to clone.
    string id = 1 [(validate.rules).string = {
        min_len: 1, 
        max_len: 36, 
        pattern: "^[a-zA-Z0-9_-]+$"  // Alphanumeric with underscores and hyphens
    }];
}

// DeleteInstanceResponse contains the result of a DeleteInstance operation.
message DeleteInstanceResponse {}

// CloneInstanceRequest defines the parameters needed to clone an existing instance.
message CloneInstanceRequest {
    // The id of the instance to clone.
    string id = 1 [(validate.rules).string = {
        min_len: 1,
        max_len: 36,
        pattern: "^[a-zA-Z0-9_-]+$"  // Alphanumeric with underscores and hyphens
    }];

    // Optional name for the cloned instance. If not provided, the clone
    // inherits the name of the source instance.
    optional string name = 2 [(validate.rules).string = {
        min_len: 1,
        max_len: 128,
        pattern: "^[a-zA-Z0-9_-]+$"
    }];
}

// CreateInstanceRequest defines the parameters needed to provision a new instance.
message CreateInstanceRequest {
    // Base image identifier to use for the instance
    string image = 1;

    // Number of CPU cores to allocate to the instance
    uint32 cpu_cores = 2 [(validate.rules).uint32 = {
        gt: 0,  // Must have at least 1 core
        lte: 99  // Maximum 99 cores
    }];

    // Amount of disk in bytes to allocate to the instance
    uint64 disk_bytes = 8 [(validate.rules).uint64 = {
        gt: 10737418240,  // Minimum 10GB (10 * 1024 * 1024 * 1024)
        lte: 536870912000 // Maximum 500GB (500 * 1024 * 1024 * 1024)
    }];

    // Amount of memory in bytes to allocate to the instance
    uint64 memory_bytes = 3 [(validate.rules).uint64 = {
        gt: 536870912,  // Minimum 512MB (512 * 1024 * 1024)
        lte: 68719476736  // Maximum 64GB (64 * 1024 * 1024 * 1024)
    }];

    // User-defined name for the instance
    string name = 4 [(validate.rules).string = {
        min_len: 1,
        max_len: 128,
        pattern: "^[a-zA-Z0-9_-]+$"
    }];

    // The snippet to use to bootstrap the instance
    string snippet = 5;

    // The id of the project the instance belongs to
    string project_id = 7 [(validate.rules).string = {
        min_len: 1,
        max_len: 36,
        pattern: "^[a-zA-Z0-9_-]+$"  // Alphanumeric with underscores and hyphens
    }];

    // Optional network interfaces for the instance.
    // If specified, the instance will be connected to the given networks.
    // If network_i_p is not specified for an interface, an IP will be auto-allocated.
    repeated NetworkInterface network_interfaces = 9;
}

// CreateInstanceResponse contains the result of a create instance operation.
message CreateInstanceResponse {
    // The created instance.
    Instance instance = 1;
}

// StartInstanceRequest identifies which instance to start.
message StartInstanceRequest {
    // Unique identifier of the instance to start
    string id = 1;
}

// StartInstanceResponse contains the result of a start instance operation.
message StartInstanceResponse {
}

// StopInstanceRequest identifies which instance to stop.
message StopInstanceRequest {
    // Unique identifier of the instance to stop
    string id = 1;
}

// StopInstanceResponse contains the result of a stop instance operation.
message StopInstanceResponse {
}

// UpdateInstanceRequest defines the parameters to update an existing instance.
message UpdateInstanceRequest {
    // Unique identifier of the instance to update
    string id = 1 [(validate.rules).string = {
        min_len: 1,
        max_len: 36,
        pattern: "^[a-zA-Z0-9_-]+$"
    }];

    // Optional new name for the instance
    optional string name = 2 [(validate.rules).string = {
        min_len: 1,
        max_len: 128,
        pattern: "^[a-zA-Z0-9_-]+$"
    }];

    // Optional new project id to move the instance to
    optional string project_id = 3 [(validate.rules).string = {
        min_len: 1,
        max_len: 36,
        pattern: "^[a-zA-Z0-9_-]+$"
    }];
}

// UpdateInstanceResponse contains the result of an update instance operation.
message UpdateInstanceResponse {
    // The updated instance.
    Instance instance = 1;
}

// ListZonesRequest is an empty message for listing zones.
message ListZonesRequest {}

// ListZonesResponse contains a collection of zone information.
message ListZonesResponse {
    // List of zone details
    repeated Zone zones = 1;
}

// CreateZoneRequest contains the new zone information.
message CreateZoneRequest {
    // User-defined name for the instance
    string name = 4 [(validate.rules).string = {
        min_len: 1,
        max_len: 128,
        pattern: "^[a-zA-Z0-9_-]+$"
    }];
}

// CreateZoneResponse contains the created zone information.
message CreateZoneResponse {
    // The created zone.
     Zone zone = 1;
}

// Zone represents a zone.
message Zone {
    // Id of the zone
    string id = 1;

    // Name of the zone.
    string name = 2;
}

// =============================================================================
// Network Messages
// =============================================================================
// Based on Google Cloud Compute API (google.cloud.compute.v1).
// Field numbers are preserved from the original proto for future compatibility.

// Network represents a VPC Network resource.
// Networks connect resources to each other and enable isolation between clients.
message Network {
    // Unique identifier for the network, defined by the server.
    optional string id = 3355;

    // Name of the resource. Must be 1-63 characters long, comply with RFC1035.
    // Pattern: `[a-z]([-a-z0-9]*[a-z0-9])?`
    optional string name = 3373707 [(validate.rules).string = {
        min_len: 1,
        max_len: 63,
        pattern: "^[a-z]([-a-z0-9]*[a-z0-9])?$"
    }];

    // Optional description of this network.
    optional string description = 422937596 [(validate.rules).string = {
        max_len: 2048
    }];

    // The range of internal addresses that are legal on this network.
    // CIDR specification, e.g., 192.168.0.0/16.
    optional string i_pv4_range = 59234358 [(validate.rules).string = {
        pattern: "^([0-9]{1,3}\\.){3}[0-9]{1,3}/[0-9]{1,2}$"
    }];

    // Gateway address for default routing out of the network, selected by the server.
    optional string gateway_i_pv4 = 178678877;

    // Maximum Transmission Unit in bytes. Min: 1300, Max: 8896, Default: 1450.
    optional int32 mtu = 108462 [(validate.rules).int32 = {
        gte: 1300,
        lte: 8896
    }];

    // Creation timestamp in RFC3339 text format.
    optional string creation_timestamp = 30525366;

    // Type of the resource. Always "compute#network" for networks.
    optional string kind = 3292052;

    // Server-defined URL for the resource.
    optional string self_link = 456214797;

    // Project ID this network belongs to.
    optional string project_id = 1000 [(validate.rules).string = {
        min_len: 1,
        max_len: 36,
        pattern: "^[a-zA-Z0-9_-]+$"
    }];
}

// Address represents an IP Address resource.
// An address resource represents an internal IP reservation within a Network.
message Address {
    // Status of the address.
    enum Status {
        UNDEFINED_STATUS = 0;
        IN_USE = 17393485;
        RESERVED = 432241448;
        RESERVING = 514587225;
    }

    // Unique identifier for the address, defined by the server.
    optional string id = 3355;

    // Name of the resource.
    optional string name = 3373707 [(validate.rules).string = {
        min_len: 1,
        max_len: 63,
        pattern: "^[a-z]([-a-z0-9]*[a-z0-9])?$"
    }];

    // Optional description of this address.
    optional string description = 422937596 [(validate.rules).string = {
        max_len: 2048
    }];

    // The static IP address represented by this resource.
    optional string address = 462920692 [(validate.rules).string = {
        pattern: "^((25[0-5]|(2[0-4]|1\\d|[1-9]|)\\d)\\.?\\b){4}$"
    }];

    // Status of the address (RESERVING, RESERVED, or IN_USE).
    optional string status = 181260274;

    // The ID of the network in which this address is reserved.
    optional string network = 232872494;

    // The IDs of the resources that are using this address.
    repeated string users = 111578632;

    // Creation timestamp in RFC3339 text format.
    optional string creation_timestamp = 30525366;

    // Type of the resource. Always "compute#address" for addresses.
    optional string kind = 3292052;

    // Server-defined URL for the resource.
    optional string self_link = 456214797;
}

// NetworkInterface represents a network interface attached to an instance.
message NetworkInterface {
    // ID of the VPC network for this interface.
    optional string network = 232872494;

    // IPv4 internal IP address for this network interface.
    // If not specified, an unused internal IP is assigned by the system.
    optional string network_i_p = 207181961 [(validate.rules).string = {
        pattern: "^((25[0-5]|(2[0-4]|1\\d|[1-9]|)\\d)\\.?\\b){4}$"
    }];

    // Name of the network interface, generated by the server.
    optional string name = 3373707;

    // Type of the resource. Always "compute#networkInterface".
    optional string kind = 3292052;
}

// InsertNetworkRequest contains parameters to create a new network.
message InsertNetworkRequest {
    // Project ID where the network will be created.
    string project_id = 1 [(validate.rules).string = {
        min_len: 1,
        max_len: 36,
        pattern: "^[a-zA-Z0-9_-]+$"
    }];

    // Name for the network. Must be unique within the project.
    string name = 2 [(validate.rules).string = {
        min_len: 1,
        max_len: 63,
        pattern: "^[a-z]([-a-z0-9]*[a-z0-9])?$"
    }];

    // Optional description of the network.
    optional string description = 3 [(validate.rules).string = {
        max_len: 2048
    }];

    // CIDR range for the network, e.g., "10.0.0.0/24".
    string i_pv4_range = 4 [(validate.rules).string = {
        pattern: "^([0-9]{1,3}\\.){3}[0-9]{1,3}/[0-9]{1,2}$"
    }];

    // Optional MTU value (1300-8896). Defaults to 1450.
    optional int32 mtu = 5 [(validate.rules).int32 = {
        gte: 1300,
        lte: 8896
    }];
}

// GetNetworkRequest identifies which network to retrieve.
message GetNetworkRequest {
    // ID of the network to retrieve.
    string id = 1 [(validate.rules).string = {
        min_len: 1,
        max_len: 36,
        pattern: "^[a-zA-Z0-9_-]+$"
    }];
}

// ListNetworksRequest contains filters for listing networks.
message ListNetworksRequest {
    // Optional project ID to filter networks by project.
    optional string project_id = 1 [(validate.rules).string = {
        min_len: 1,
        max_len: 36,
        pattern: "^[a-zA-Z0-9_-]+$"
    }];
}

// NetworkList contains a collection of networks.
message NetworkList {
    // List of networks.
    repeated Network networks = 1;

    // Type of resource. Always "compute#networkList".
    optional string kind = 2;
}

// DeleteNetworkRequest identifies which network to delete.
message DeleteNetworkRequest {
    // ID of the network to delete.
    string id = 1 [(validate.rules).string = {
        min_len: 1,
        max_len: 36,
        pattern: "^[a-zA-Z0-9_-]+$"
    }];
}

// DeleteNetworkResponse contains the result of a delete network operation.
message DeleteNetworkResponse {}
